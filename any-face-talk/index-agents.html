<!DOCTYPE html>
<html>
  <head>
    <title>New Era | Any Face Talk</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@300;400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="style-agents.css" />
    <link rel="icon" type="image/png" href="Icon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  </head>

  <body class="custom-scroll">
    <div id="content">
      <div id="status" class="status d-none">
        <div>
          <h4>Agent Status</h4>
          <div>
            <p>Agent ID: <label id="agentId-label"></label></p>
            <p>Chat ID: <label id="chatId-label"></label></p>
          </div>
          <br />
        </div>
        <div>
          <h4>WebRTC Connection Status</h4>
          ICE gathering status: <label id="ice-gathering-status-label"></label><br />
          ICE status: <label id="ice-status-label"></label><br />
          Peer connection status: <label id="peer-status-label"></label><br />
          Signaling status: <label id="signaling-status-label"></label><br />
          Streaming status: <label id="streaming-status-label"></label><br />
          <br />
        </div>
        <div id="buttons">
          <button id="connect-button" class="d-none" type="button">Connect</button>
          <button id="destroy-button" class="d-none" type="button">Destroy</button>

          <div class="dropdown d-none">
            <button
              class="btn btn-secondary dropdown-toggle"
              type="button"
              id="dropdownMenuButton"
              data-bs-toggle="dropdown"
              aria-expanded="false"
            >
            CF-Maisie-GB
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
              <li><a class="dropdown-item" href="#" data-value="en-US-DavisNeural">M-Davis-US</a></li>
              <li><a class="dropdown-item" href="#" data-value="zh-CN-YunxiaNeural">CM-Yunxia-CN</a></li>
              <li><a class="dropdown-item" href="#" data-value="en-AU-NatashaNeural">F-Natasha-AU</a></li>
              <li><a class="dropdown-item" href="#" data-value="zh-CN-XiaoxiaoNeural">F-Xiaoxiao-CN-Lyrical</a></li>
              <li><a class="dropdown-item" href="#" data-value="en-US-JennyNeural">F-Jenny-US-Angry</a></li>
              <li><a class="dropdown-item" href="#" data-value="en-GB-MaisieNeural">CF-Maisie-GB</a></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="second-div">
        <div id="video-wrapper" class="video-wrapper">
          <div class="video-div">
            <video id="video-element" src="" autoplay loop muted class="animated"></video>
          </div>
        </div>
        <div class="chat">
          <h4>Chat History</h4>
          <div>
            <div id="msgHistory"></div>
          </div>
        </div>
        <div>
          <button id="agents-button" class="mb-2" type="button">Trun On</button>
          <textarea id="textArea" cols="50" rows="5" maxlength="280"></textarea>
          <br />
          <button id="start-button" class="d-none" type="button">Start</button>
        </div>
      </div>
    </div>

    <script type="module" src="./agents-client-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const dropdownMenu = document.querySelector('.dropdown-menu');
        const dropdownButton = document.getElementById('dropdownMenuButton');
        const createButton = document.getElementById('agents-button');
        const connectButton = document.getElementById('connect-button');
        const startButton = document.getElementById('start-button');
        const storedVoice = localStorage.getItem('selectedVoice');
        if (storedVoice) {
          dropdownButton.textContent = storedVoice;
        }
        dropdownMenu.addEventListener('click', function (event) {
          const target = event.target.closest('.dropdown-item');
          if (!target) return;
          const selectedVoiceText = target.textContent;
          const selectedVoiceValue = target.getAttribute('data-value');
          dropdownButton.textContent = selectedVoiceText;
          localStorage.setItem('selectedVoice', selectedVoiceValue);
          createButton.click();
        });

        createButton.addEventListener('click', function () {
          console.log('Creating agent...');
          setTimeout(function () {
            console.log('Agent created successfully.');
            connectButton.click();
          }, 1000);
        });

        const textArea = document.getElementById('textArea');
        let timer;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          console.error('Web Speech API is not supported in this browser.');
          return;
        }
        const recognition = new SpeechRecognition();

        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        recognition.start();

        recognition.onstart = function () {
          console.log('Speech recognition started');
        };

        recognition.onresult = function (event) {
          const transcript = event.results[0][0].transcript;
          textArea.value = transcript;
          console.log('Speech recognition result: ', transcript);

          if (timer) {
            clearTimeout(timer);
          }

          timer = setTimeout(() => {
            if (textArea.value.trim()) {
              console.log('Simulating button click after 3 seconds of inactivity.');
              startButton.click();
            }
          }, 1500);
        };

        recognition.onerror = function (event) {
          console.error('Speech recognition error detected: ' + event.error);
          if (event.error === 'network') {
            console.error('There is a network error. Please check your internet connection.');
          }
        };

        recognition.onend = function () {
          console.log('Speech recognition service disconnected. Restarting...');
          recognition.start();
        };
      });
    </script>
  </body>
</html>
